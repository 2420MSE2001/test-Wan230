name: Manual Grading

on: 
  workflow_dispatch:  # 手动触发

jobs:
  autograde:
    runs-on: ubuntu-latest

    
    steps:
    - name: Checkout Code

      uses: actions/checkout@v4

    - name: Set up Python

      uses: actions/setup-python@v4

      with:
        python-version: '3.10'

    # 新增依赖安装步骤 ▼▼▼

    - name: Install Dependencies

      run: |
        if [ -f "requirements.txt" ]; then

          echo "正在安装全局依赖..."
          pip install -r requirements.txt

        else

          echo "::warning::根目录未找到requirements.txt文件"
        fi

    - name: Run All Tests

      run: |
        total_score=0
    
        tested_count=0
    
        has_errors=0
    
        # 确保pytest可用
    
        if ! command -v pytest &> /dev/null; then
    
          echo "::error::pytest未安装，正在自动安装..."
          pip install pytest
    
        fi
    
        for problem in Problem1 Problem2 Problem3 Problem4 Problem5; do
    
          echo "▄▄▄▄▄▄▄ Testing $problem ▄▄▄▄▄▄▄"
          
          if [ -d "$problem" ]; then
    
            cd $problem || { echo "::error::进入$problem目录失败"; has_errors=1; continue; }
            
            if [ -f "test.py" ]; then
    
              set +e
    
              # 使用pytest执行测试并捕获结果
    
              pytest test.py -v --tb=short  # 添加详细输出
    
              test_exit=$?
              set -e
    
              # 根据pytest结果计分
    
              if [ $test_exit -eq 0 ]; then
    
                echo "$problem 测试通过 ✅"
                ((total_score+=20))
              else
    
                echo "$problem 测试失败 ❌"
                has_errors=1
    
              fi
    
            else
    
              echo "::error::缺少测试文件 $problem/test.py"
              has_errors=1
    
            fi
    
            
            cd ..
            ((tested_count++))
          else
    
            echo "::warning::$problem 目录未找到"
          fi
    
          echo ""
        done
    
        echo "已测试题目数: $tested_count/5"
        echo "总得分: $total_score/100"
        exit 0
